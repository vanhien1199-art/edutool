<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·∫†O NG√ÇN H√ÄNG C√ÇU H·ªéI CHO H·ªÜ TH√îNG VNEDU LMS</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css">
    
    <link rel="stylesheet" href="css/style.css"> 
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>üõ°Ô∏è T·∫†O NG√ÇN H√ÄNG C√ÇU H·ªéI CHO H·ªÜ TH·ªêNG VNEDU LMS</h2>
        <hr>
        <div class="row">
            <div class="six columns">
                <label>M√¥n h·ªçc</label>
                <input class="u-full-width" type="text" id="mon_hoc" placeholder="VD: Khoa h·ªçc t·ª± nhi√™n">
                
                <label>L·ªõp</label>
                <input class="u-full-width" type="text" id="lop" placeholder="VD: 8">
                
                <label>B·ªô s√°ch gi√°o khoa</label>
                <select class="u-full-width" id="bo_sach">
                    <option value="K·∫øt n·ªëi tri th·ª©c v·ªõi cu·ªôc s·ªëng">K·∫øt n·ªëi tri th·ª©c v·ªõi cu·ªôc s·ªëng</option>
                    <option value="Ch√¢n tr·ªùi s√°ng t·∫°o">Ch√¢n tr·ªùi s√°ng t·∫°o</option>
                    <option value="C√°nh Di·ªÅu">C√°nh Di·ªÅu</option>
                </select>
                
                <label>Ch·ªß ƒë·ªÅ b√†i h·ªçc</label>
                <textarea class="u-full-width" id="bai_hoc" placeholder="VD: ƒêo t·ªëc ƒë·ªô"></textarea>
            </div>
            
            <div class="six columns">
                <label>S·ªë l∆∞·ª£ng & Lo·∫°i c√¢u h·ªèi</label>
                <div class="row">
                    <div class="six columns">
                        <label>TN 4 ch·ªçn 1</label>
                        <input type="number" id="c1" value="4" min="0">
                    </div>
                    <div class="six columns">
                        <label>ƒê√∫ng/Sai</label>
                        <input type="number" id="c2" value="0" min="0">
                    </div>
                </div>
                <div class="row">
                    <div class="six columns">
                        <label>ƒêi·ªÅn khuy·∫øt</label>
                        <input type="number" id="c3" value="0" min="0">
                    </div>
                    <div class="six columns">
                        <label>K√©o th·∫£</label>
                        <input type="number" id="c4" value="0" min="0">
                    </div>
                </div>
                <div class="row">
                    <div class="six columns">
                        <label>C√¢u ch√πm</label>
                        <input type="number" id="c5" value="0" min="0">
                    </div>
                    <div class="six columns">
                        <label>T·ª± lu·∫≠n</label>
                        <input type="number" id="c6" value="0" min="0">
                    </div>
                </div>
            </div>
        </div>
        <div style="background-color: #e8f0fe; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid #4285f4;">
            <label style="color: #1a73e8; font-weight: bold;">üîë M√£ k√≠ch ho·∫°t (License Key)</label>
            <input class="u-full-width" type="text" id="license_key" placeholder="Nh·∫≠p m√£ b·∫°n ƒë√£ mua v√†o ƒë√¢y..." style="border: 2px solid #4285f4; font-weight: bold;">
            <small style="color: #666;">* Li√™n h·ªá Admin ƒë·ªÉ mua m√£ k√≠ch ho·∫°t ph·∫ßn m·ªÅm.</small>
        </div>
        <button class="button-primary" id="btnGenerate">üöÄ T·∫°o File Excel Ngay</button>
        
        ```

---

### B∆Ø·ªöC 2: G·ª¨I M√É L√äN SERVER (`public/js/excel-gen.js`)

Ch√∫ng ta c·∫ßn l·∫•y n·ªôi dung trong √¥ m√£ k√≠ch ho·∫°t v√† g·ª≠i n√≥ k√®m theo d·ªØ li·ªáu m√¥n h·ªçc/l·ªõp h·ªçc.

B·∫°n **Copy to√†n b·ªô** code d∆∞·ªõi ƒë√¢y d√°n ƒë√® v√†o `public/js/excel-gen.js`. (T√¥i ƒë√£ th√™m ph·∫ßn l·∫•y `license_key` v√†o payload).

```javascript
// File: public/js/excel-gen.js
// Phi√™n b·∫£n: COMMERCIAL (C√≥ m√£ b·∫£o m·∫≠t)

document.addEventListener('DOMContentLoaded', () => {
    console.log("--- CLIENT LOADED: COMMERCIAL VERSION ---");
    const btnGenerate = document.getElementById('btnGenerate');
    if (btnGenerate) btnGenerate.addEventListener('click', handleGenerate);
});

async function handleGenerate() {
    const btn = document.getElementById('btnGenerate');
    const loading = document.getElementById('loadingMsg');
    const success = document.getElementById('successMsg');
    const error = document.getElementById('errorMsg');

    // UI Helpers
    const setDisplay = (el, style) => { if (el) el.style.display = style; };
    const setText = (el, text) => { if (el) el.textContent = text; };

    // Reset UI
    setDisplay(loading, 'block');
    setDisplay(success, 'none');
    setDisplay(error, 'none');
    setText(error, '');
    if (btn) btn.disabled = true;

    try {
        // 1. L·∫§Y M√É B·∫¢N QUY·ªÄN
        const licenseKey = document.getElementById('license_key').value.trim();
        
        if (!licenseKey) {
            throw new Error("B·∫°n ch∆∞a nh·∫≠p M√£ k√≠ch ho·∫°t! Vui l√≤ng nh·∫≠p m√£ ƒë·ªÉ s·ª≠ d·ª•ng.");
        }

        // 2. Thu th·∫≠p d·ªØ li·ªáu
        const payload = {
            license_key: licenseKey, // <--- G·ª≠i m√£ l√™n server
            mon_hoc: document.getElementById('mon_hoc').value.trim(),
            lop: document.getElementById('lop').value.trim(),
            bo_sach: document.getElementById('bo_sach').value,
            bai_hoc: document.getElementById('bai_hoc').value.trim(),
            c1: parseInt(document.getElementById('c1').value)||0,
            c2: parseInt(document.getElementById('c2').value)||0,
            c3: parseInt(document.getElementById('c3').value)||0,
            c4: parseInt(document.getElementById('c4').value)||0,
            c5: parseInt(document.getElementById('c5').value)||0,
            c6: parseInt(document.getElementById('c6').value)||0
        };

        if (!payload.mon_hoc || !payload.bai_hoc) {
            throw new Error("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß M√¥n h·ªçc v√† Ch·ªß ƒë·ªÅ b√†i h·ªçc!");
        }

        // 3. G·ªåI API
        const timestamp = new Date().getTime();
        const apiUrl = `/api_v2?t=${timestamp}`; 

        console.log("ƒêang g·ªçi API:", apiUrl);
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const rawText = await response.text();
        
        // X·ª≠ l√Ω c√°c l·ªói ƒë·∫∑c th√π
        if (response.status === 403) throw new Error("‚õî M√É K√çCH HO·∫†T KH√îNG H·ª¢P L·ªÜ ho·∫∑c ƒê√É H·∫æT H·∫†N!");
        if (!response.ok) throw new Error(`L·ªói Server ${response.status}: ${rawText}`);

        let data;
        try { data = JSON.parse(rawText); } catch (e) { throw new Error("L·ªói JSON: " + rawText); }
        
        const content = data.result || data.answer;
        if (!content) throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu tr·∫£ v·ªÅ t·ª´ AI.");

        // 4. T·∫°o Excel
        createAndDownloadExcel(content, payload);
        setDisplay(success, 'block');

    } catch (err) {
        console.error(err);
        if(error) { 
            // Hi·ªán l·ªói to r√µ h∆°n
            error.innerHTML = `<strong>${err.message}</strong>`; 
            error.style.display = 'block'; 
        }
    } finally {
        setDisplay(loading, 'none');
        if (btn) btn.disabled = false;
    }
}

function createAndDownloadExcel(rawText, payload) {
    if (typeof XLSX === 'undefined') { alert("L·ªói th∆∞ vi·ªán SheetJS"); return; }

    const cleanText = rawText.replace(/```csv/g, "").replace(/```/g, "").trim();
    const lines = cleanText.split('\n');
    const finalData = [];
    const TOTAL_COLS = 22;

    let row1 = new Array(TOTAL_COLS).fill(""); row1[7] = "IMPORT C√ÇU H·ªéI";
    let row2 = new Array(TOTAL_COLS).fill(""); row2[7] = "(Ch√∫ √Ω: c√°c c·ªôt b√¥i ƒë·ªè l√† b·∫Øt bu·ªôc)";
    let row3 = new Array(TOTAL_COLS).fill(""); 
    const headers = [
        'STT', 'Lo·∫°i c√¢u h·ªèi', 'ƒê·ªô kh√≥', 'M·ª©c ƒë·ªô nh·∫≠n th·ª©c', 'ƒê∆°n v·ªã ki·∫øn th·ª©c', 'M·ª©c ƒë·ªô ƒë√°nh gi√°',
        'L√† c√¢u h·ªèi con c·ªßa c√¢u h·ªèi ch√πm?', 'N·ªôi dung c√¢u h·ªèi', 'ƒê√°p √°n ƒë√∫ng',
        'ƒê√°p √°n 1', 'ƒê√°p √°n 2', 'ƒê√°p √°n 3', 'ƒê√°p √°n 4', 'ƒê√°p √°n 5', 'ƒê√°p √°n 6', 'ƒê√°p √°n 7', 'ƒê√°p √°n 8',
        'Tags (ph√¢n c√°ch nhau b·∫±ng d·∫•u ;)', 'Gi·∫£i th√≠ch', 'ƒê·∫£o ƒë√°p √°n',
        'T√≠nh ƒëi·ªÉm m·ªói ƒë√°p √°n ƒë√∫ng', 'Nh√≥m ƒë√°p √°n theo t·ª´ng ch·ªó tr·ªëng'
    ];
    finalData.push(row1, row2, row3, headers);

    for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();
        if (!line || !line.includes('|')) continue;
        if (line.includes("Lo·∫°i c√¢u h·ªèi") && line.includes("ƒê·ªô kh√≥")) continue; 

        let parts = line.split('|');
        if (parts.length > TOTAL_COLS) parts = parts.slice(0, TOTAL_COLS);
        while (parts.length < TOTAL_COLS) parts.push("");

        parts = parts.map(cell => {
            if (typeof cell === 'string') {
                let p = cell;
                p = p.replace(/<br\s*\/?>/gi, '\n');
                p = p.replace(/\^/g, '|'); 
                return p;
            }
            return cell;
        });

        if (!isNaN(parseInt(parts[0]))) finalData.push(parts);
    }

    const ws = XLSX.utils.aoa_to_sheet(finalData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    const safeMon = payload.mon_hoc.replace(/[^a-z0-9]/gi, '_');
    XLSX.writeFile(wb, `NHCH_${safeMon}_${new Date().getTime()}.xlsx`);
}
        <button class="button-primary" id="btnGenerate">üöÄ T·∫°o File Excel Ngay</button>
        
        <div id="statusArea">
            <p class="loading" id="loadingMsg" style="display: none;">AI ƒëang suy nghƒ© v√† t·∫°o c√¢u h·ªèi (c√≥ th·ªÉ m·∫•t 20-30s)...</p>
            <p class="success" id="successMsg" style="display: none;">‚úÖ ƒê√£ t·∫°o xong! ƒêang t·∫£i file xu·ªëng...</p>
            <p class="error" id="errorMsg" style="display: none;"></p>
        </div>
    </div>

    <script src="js/excel-gen.js"></script>
</body>
</html>


