<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·∫°o Ng√¢n H√†ng C√¢u H·ªèi AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        .container { max-width: 960px; margin-top: 50px; }
        .loading { color: #e67e22; font-weight: bold; display: none; }
        .error { color: red; display: none; }
        .success { color: green; display: none; }
        input[type="number"] { width: 100%; }
    </style>
</head>
<body>
    <div class="container">
        <h3>üõ°Ô∏è T·∫°o Ng√¢n H√†ng C√¢u H·ªèi (Cloudflare AI)</h3>
        <hr>
        <div class="row">
            <div class="six columns">
                <label>M√¥n h·ªçc</label>
                <input class="u-full-width" type="text" id="mon_hoc" placeholder="V√≠ d·ª•: Khoa h·ªçc t·ª± nhi√™n">
                
                <label>L·ªõp</label>
                <input class="u-full-width" type="text" id="lop" placeholder="V√≠ d·ª•: 8">
                
                <label>B·ªô s√°ch</label>
                <select class="u-full-width" id="bo_sach">
                    <option value="K·∫øt n·ªëi tri th·ª©c v·ªõi cu·ªôc s·ªëng">K·∫øt n·ªëi tri th·ª©c v·ªõi cu·ªôc s·ªëng</option>
                    <option value="Ch√¢n tr·ªùi s√°ng t·∫°o">Ch√¢n tr·ªùi s√°ng t·∫°o</option>
                    <option value="C√°nh Di·ªÅu">C√°nh Di·ªÅu</option>
                </select>
                
                <label>Ch·ªß ƒë·ªÅ b√†i h·ªçc</label>
                <textarea class="u-full-width" id="bai_hoc" placeholder="V√≠ d·ª•: ƒêo t·ªëc ƒë·ªô"></textarea>
            </div>
            <div class="six columns">
                <label>S·ªë l∆∞·ª£ng c√¢u h·ªèi</label>
                <div class="row">
                    <div class="six columns">
                        <label>Tr·∫Øc nghi·ªám (4 ch·ªçn 1)</label>
                        <input type="number" id="c1" value="4" min="0">
                    </div>
                    <div class="six columns">
                        <label>ƒê√∫ng/Sai</label>
                        <input type="number" id="c2" value="0" min="0">
                    </div>
                </div>
                <div class="row">
                    <div class="six columns">
                        <label>ƒêi·ªÅn khuy·∫øt</label>
                        <input type="number" id="c3" value="0" min="0">
                    </div>
                    <div class="six columns">
                        <label>K√©o th·∫£</label>
                        <input type="number" id="c4" value="0" min="0">
                    </div>
                </div>
                <div class="row">
                    <div class="six columns">
                        <label>C√¢u h·ªèi ch√πm</label>
                        <input type="number" id="c5" value="0" min="0">
                    </div>
                    <div class="six columns">
                        <label>T·ª± lu·∫≠n</label>
                        <input type="number" id="c6" value="0" min="0">
                    </div>
                </div>
            </div>
        </div>
        <button class="button-primary" id="btn-submit">üöÄ T·∫°o File Excel Ngay</button>
        
        <p class="loading" id="status-msg">AI ƒëang x·ª≠ l√Ω... Vui l√≤ng ch·ªù kho·∫£ng 15-30 gi√¢y...</p>
        <p class="error" id="error-msg"></p>
        <p class="success" id="success-msg">‚úÖ ƒê√£ t·∫°o xong! File ƒëang t·∫£i xu·ªëng.</p>
    </div>

    <script>
        document.getElementById('btn-submit').addEventListener('click', async () => {
            const btn = document.getElementById('btn-submit');
            const loading = document.getElementById('status-msg');
            const errorDiv = document.getElementById('error-msg');
            const successDiv = document.getElementById('success-msg');

            // Reset tr·∫°ng th√°i
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            btn.disabled = true;
            loading.style.display = 'block';

            // L·∫•y d·ªØ li·ªáu form
            const payload = {
                mon_hoc: document.getElementById('mon_hoc').value,
                lop: document.getElementById('lop').value,
                bo_sach: document.getElementById('bo_sach').value,
                bai_hoc: document.getElementById('bai_hoc').value,
                c1: parseInt(document.getElementById('c1').value) || 0,
                c2: parseInt(document.getElementById('c2').value) || 0,
                c3: parseInt(document.getElementById('c3').value) || 0,
                c4: parseInt(document.getElementById('c4').value) || 0,
                c5: parseInt(document.getElementById('c5').value) || 0,
                c6: parseInt(document.getElementById('c6').value) || 0,
            };

            if (!payload.mon_hoc || !payload.bai_hoc) {
                alert("Vui l√≤ng nh·∫≠p M√¥n h·ªçc v√† Ch·ªß ƒë·ªÅ!");
                btn.disabled = false;
                loading.style.display = 'none';
                return;
            }

            try {
                // 1. G·ªçi Backend Cloudflare Function
                const response = await fetch('/functions/generateQuiz', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (!response.ok) throw new Error(data.error || "L·ªói Server");
                if (!data.rawData) throw new Error("AI kh√¥ng tr·∫£ v·ªÅ d·ªØ li·ªáu.");

                // 2. X·ª≠ l√Ω d·ªØ li·ªáu th√¥ (Raw Text) th√†nh m·∫£ng Excel
                const rawText = data.rawData.replace(/```csv/g, "").replace(/```/g, "").trim();
                const lines = rawText.split('\n');
                
                // M·∫£ng ch·ª©a d·ªØ li·ªáu cu·ªëi c√πng
                const finalData = [];

                // --- T·∫°o 2 d√≤ng ƒë·∫ßu ti√™n theo ƒë√∫ng m·∫´u app.py ---
                const headerCols = 22;
                const emptyRow = new Array(headerCols).fill("");
                
                // D√≤ng 1: IMPORT C√ÇU H·ªéI (C·ªôt H)
                const row1 = [...emptyRow];
                row1[7] = "IMPORT C√ÇU H·ªéI";
                finalData.push(row1);

                // D√≤ng 2: Ch√∫ √Ω (C·ªôt H)
                const row2 = [...emptyRow];
                row2[7] = "(Ch√∫ √Ω: c√°c c·ªôt b√¥i ƒë·ªè l√† b·∫Øt bu·ªôc)";
                finalData.push(row2);

                // D√≤ng 3: Header chu·∫©n
                const headers = [
                    'STT', 'Lo·∫°i c√¢u h·ªèi', 'ƒê·ªô kh√≥', 'M·ª©c ƒë·ªô nh·∫≠n th·ª©c', 'ƒê∆°n v·ªã ki·∫øn th·ª©c', 'M·ª©c ƒë·ªô ƒë√°nh gi√°',
                    'L√† c√¢u h·ªèi con c·ªßa c√¢u h·ªèi ch√πm?', 'N·ªôi dung c√¢u h·ªèi', 'ƒê√°p √°n ƒë√∫ng',
                    'ƒê√°p √°n 1', 'ƒê√°p √°n 2', 'ƒê√°p √°n 3', 'ƒê√°p √°n 4', 'ƒê√°p √°n 5', 'ƒê√°p √°n 6', 'ƒê√°p √°n 7', 'ƒê√°p √°n 8',
                    'Tags (ph√¢n c√°ch nhau b·∫±ng d·∫•u ;)', 'Gi·∫£i th√≠ch', 'ƒê·∫£o ƒë√°p √°n',
                    'T√≠nh ƒëi·ªÉm m·ªói ƒë√°p √°n ƒë√∫ng', 'Nh√≥m ƒë√°p √°n theo t·ª´ng ch·ªó tr·ªëng'
                ];
                finalData.push(headers);

                // --- X·ª≠ l√Ω d·ªØ li·ªáu t·ª´ AI ---
                // B·ªè d√≤ng header do AI sinh ra (th∆∞·ªùng l√† d√≤ng ƒë·∫ßu ti√™n) n·∫øu n√≥ tr√πng header
                let startIdx = 0;
                if (lines.length > 0 && lines[0].includes("STT|Lo·∫°i c√¢u h·ªèi")) {
                    startIdx = 1;
                }

                for (let i = startIdx; i < lines.length; i++) {
                    let line = lines[i].trim();
                    if (!line) continue;

                    let parts = line.split('|');
                    
                    // X·ª≠ l√Ω thi·∫øu/th·ª´a c·ªôt
                    if (parts.length > headerCols) {
                        parts = parts.slice(0, headerCols);
                    } else if (parts.length < headerCols) {
                        while (parts.length < headerCols) parts.push("");
                    }
                    
                    // Fix l·ªói STT (n·∫øu AI tr·∫£ v·ªÅ text thay v√¨ s·ªë)
                    if(isNaN(parseInt(parts[0]))) continue; // B·ªè qua d√≤ng kh√¥ng c√≥ STT h·ª£p l·ªá

                    finalData.push(parts);
                }

                // 3. T·∫°o file Excel b·∫±ng SheetJS
                const worksheet = XLSX.utils.aoa_to_sheet(finalData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");

                // T·∫£i xu·ªëng
                XLSX.writeFile(workbook, `Cau_hoi_${payload.mon_hoc}_${payload.lop}.xlsx`);

                successDiv.style.display = 'block';

            } catch (err) {
                console.error(err);
                errorDiv.textContent = "L·ªói: " + err.message;
                errorDiv.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>